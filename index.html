<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bridge Nine - Phone Pricing Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .quick-check-section {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 20px 30px;
            border-bottom: 3px solid #f39c12;
        }

        .quick-check-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-check-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .quick-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .quick-input-group label {
            font-weight: 600;
            font-size: 0.9em;
            color: #2d3436;
        }

        .quick-input-group input,
        .quick-input-group select {
            padding: 8px 12px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .quick-input-group input:focus,
        .quick-input-group select:focus {
            outline: none;
            border-color: #f39c12;
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .quick-check-btn {
            background: linear-gradient(135deg, #e67e22 0%, #d63031 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .quick-check-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .quick-result {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .quick-result.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-result-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .quick-result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .quick-stat {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .quick-stat-label {
            font-size: 0.85em;
            color: #636e72;
            margin-bottom: 5px;
        }

        .quick-stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3436;
        }

        .quick-stat.good {
            border-left-color: #00b894;
            background: #d4edda;
        }

        .quick-stat.bad {
            border-left-color: #d63031;
            background: #f8d7da;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .upload-box {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .upload-label {
            font-weight: 600;
            color: #495057;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            overflow: hidden;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }

        .file-input-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-block;
            position: relative;
            z-index: 1;
        }

        .file-input-btn:hover {
            background: #218838;
        }

        .upload-status {
            color: #28a745;
            font-weight: 600;
        }

        .settings-bar {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e0e0e0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .setting-group label {
            font-weight: 600;
            color: #495057;
            font-size: 13px;
        }

        .setting-group select,
        .setting-group input {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(40, 167, 69, 0.3);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-btn.changed {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 2px 5px rgba(40, 167, 69, 0.3); }
            50% { box-shadow: 0 4px 15px rgba(40, 167, 69, 0.6); }
        }

        .control-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .control-btn.active {
            background: #28a745;
        }

        .main-content {
            padding: 30px;
        }

        .recommendations {
            margin-bottom: 30px;
        }

        .rec-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .rec-grid.table-view {
            display: block;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        .data-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #e0e0e0;
            border-right: 1px solid #f0f0f0;
            font-size: 12px;
        }

        .data-table tr:hover {
            background: #fffacd !important;
        }

        .data-table tr.good-row {
            background: #f0fff4;
        }

        .data-table tr.bad-row {
            background: #fff5f5;
        }

        .data-table .status-good {
            color: #28a745;
            font-weight: 600;
        }

        .data-table .status-bad {
            color: #dc3545;
            font-weight: 600;
        }

        .rec-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .rec-card.good-deal {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .rec-card.bad-deal {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .deal-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .deal-badge.good {
            background: #28a745;
            color: white;
        }

        .deal-badge.bad {
            background: #dc3545;
            color: white;
        }

        .rec-card h3 {
            color: #333;
            margin-bottom: 5px;
            font-size: 1em;
        }

        .model-info {
            color: #6c757d;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .grade-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .grade-1 { background: #28a745; color: white; }
        .grade-2 { background: #ffc107; color: #000; }
        .grade-3 { background: #fd7e14; color: white; }
        .grade-pgl { background: #6f42c1; color: white; }

        .price-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .price-box {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .max-price-box {
            background: #e7f3ff;
        }

        .your-price-box {
            background: #f0fff4;
        }

        .your-price-box.overpaid {
            background: #fff5f5;
        }

        .price-label {
            font-size: 0.75em;
            color: #6c757d;
            margin-bottom: 3px;
        }

        .price-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .your-price-box .price-value {
            color: #28a745;
        }

        .your-price-box.overpaid .price-value {
            color: #dc3545;
        }

        .savings {
            font-size: 0.85em;
            margin-top: 5px;
            font-weight: 600;
            color: #28a745;
        }

        .overpaid {
            color: #dc3545;
        }

        .stats {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 10px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .cost-breakdown {
            background: #fff3cd;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.8em;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .summary-box {
            background: #f8f9fa;
            border: 2px solid #667eea;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .summary-value.good {
            color: #28a745;
        }

        .summary-value.bad {
            color: #dc3545;
        }

        h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        @media (max-width: 768px) {
            .settings-bar {
                grid-template-columns: 1fr;
            }
            .rec-grid {
                grid-template-columns: 1fr;
            }
            .price-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Bridge Nine - Phone Pricing Calculator</h1>
            <p>Calculate maximum purchase prices & analyze your deals</p>
        </div>

        <!-- Quick Check Section -->
        <div class="quick-check-section">
            <div class="quick-check-title">
                ‚ö° Quick Check - Single Item
            </div>
            <div class="quick-check-inputs">
                <div class="quick-input-group">
                    <label>Make</label>
                    <select id="quickMake">
                        <option value="">Select Make...</option>
                    </select>
                </div>
                <div class="quick-input-group">
                    <label>Model</label>
                    <select id="quickModel">
                        <option value="">Select Model...</option>
                    </select>
                </div>
                <div class="quick-input-group">
                    <label>Storage</label>
                    <select id="quickMemory">
                        <option value="">Select Storage...</option>
                    </select>
                </div>
                <div class="quick-input-group">
                    <label>Grade</label>
                    <select id="quickGrade">
                        <option value="A">A (Best - Like New)</option>
                        <option value="B">B (Good)</option>
                        <option value="C">C (Fair - Visible Wear)</option>
                        <option value="D">D (Acceptable - Heavy Wear)</option>
                        <option value="E">E (Poor - Defects/B-Stock)</option>
                    </select>
                </div>
                <div class="quick-input-group">
                    <label>Your Price (‚Ç¨)</label>
                    <input type="number" id="quickPrice" placeholder="65" step="0.01">
                </div>
                <div class="quick-input-group">
                    <label>Target Margin (%)</label>
                    <input type="number" id="quickTargetMargin" value="20" min="0" max="100" step="1">
                </div>
                <div class="quick-input-group" style="display: flex; align-items: flex-end;">
                    <button class="quick-check-btn" id="quickCheckBtn">üîç Check Now</button>
                </div>
            </div>
            <div id="quickResult" class="quick-result">
                <!-- Results will be populated here -->
            </div>
        </div>

        <div class="upload-section">
            <div class="upload-box">
                <span class="upload-label">üì§ Upload File to Analyze Prices:</span>
                <div class="file-input-wrapper">
                    <div class="file-input-btn">Choose Excel File</div>
                    <input type="file" id="stockUpload" accept=".xlsx,.xls,.csv">
                </div>
                <span id="uploadStatus" class="upload-status"></span>
                <button id="clearFileBtn" class="control-btn" style="display: none; margin-left: 10px;">Clear</button>
            </div>
            <div class="upload-box" style="margin-top: 15px; border-top: 1px solid #dee2e6; padding-top: 15px;">
                <span class="upload-label">üìä Update Sales Prices Database:</span>
                <div class="file-input-wrapper">
                    <div class="file-input-btn" style="background: #17a2b8;">Update Refurbed Prices</div>
                    <input type="file" id="salesUpload" accept=".xlsx,.xls,.csv">
                </div>
                <span id="salesUploadStatus" class="upload-status"></span>
            </div>
        </div>

        <div class="settings-bar">
            <div class="setting-group">
                <label>Sales Platform</label>
                <select id="platform">
                    <option value="refurbed">Refurbed</option>
                    <option value="backmarket">BackMarket</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Commission (%)</label>
                <input type="number" id="commission" value="12" min="0" max="50" step="0.5">
            </div>
            <div class="setting-group">
                <label>VAT Treatment</label>
                <select id="vatTreatment">
                    <option value="marginal">Marginal VAT (M)</option>
                    <option value="reverse">Reverse Charge (R)</option>
                </select>
            </div>
            <div class="setting-group">
                <label>VAT Rate (%)</label>
                <input type="number" id="vatRate" value="25" min="0" max="30" step="0.1">
            </div>
            <div class="setting-group">
                <label>Accessories (‚Ç¨)</label>
                <input type="number" id="accessories" value="3" min="0" step="0.5">
            </div>
            <div class="setting-group">
                <label>Freight (‚Ç¨)</label>
                <input type="number" id="freight" value="15" min="0" step="0.5">
            </div>
            <div class="setting-group">
                <label>Target Margin (%)</label>
                <input type="number" id="targetMargin" value="20" min="0" max="100" step="1">
            </div>
            <div class="setting-group" style="display: flex; align-items: flex-end;">
                <button id="refreshBtn" class="refresh-btn">üîÑ Update Prices</button>
            </div>
        </div>

        <div class="main-content">
            
            <div class="info-box" style="background: #d4edda; border-left-color: #28a745;">
                <strong>üí° Tip:</strong> The upload button is at the top of the page! Upload your Excel file (like the proposal) to see how your prices compare to the recommended maximums.
            </div>
            
            <div class="recommendations">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">üéØ Purchase Price Analysis</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="viewToggleBtn" class="control-btn">üìã Table View</button>
                        <button id="sortAlphaBtn" class="control-btn">üî§ Sort A-Z</button>
                        <button id="sortProfitBtn" class="control-btn">üí∞ Sort by Profit</button>
                        <button id="exportExcelBtn" class="control-btn">üìä Export Excel</button>
                    </div>
                </div>
                <div class="info-box">
                    <strong>How it works:</strong> 
                    <ul style="margin: 10px 0 0 20px;">
                        <li><strong>Without file:</strong> See recommended max prices for popular models based on Refurbed sales</li>
                        <li><strong>With file:</strong> Upload your Excel to compare your actual prices vs recommended prices</li>
                    </ul>
                </div>
                <div id="recommendations" class="rec-grid"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const REFURBED_SALES_PRICES = {"GOOGLE PIXEL 7 PRO|12GB|GRADE 2":{"avgPrice":250.75,"salesCount":111,"minPrice":235.0,"maxPrice":369.99},"GOOGLE PIXEL 8 PRO|12GB|GRADE 2":{"avgPrice":397.1,"salesCount":91,"minPrice":350.0,"maxPrice":656.99},"GOOGLE PIXEL 8A|8GB|GRADE 2":{"avgPrice":303.65,"salesCount":65,"minPrice":285.0,"maxPrice":415.99},"GOOGLE PIXEL 8A|8GB|GRADE 3":{"avgPrice":287.11,"salesCount":60,"minPrice":270.48,"maxPrice":388.99},"GOOGLE PIXEL 7 PRO|12GB|GRADE 3":{"avgPrice":241.8,"salesCount":58,"minPrice":225.0,"maxPrice":369.99},"GOOGLE PIXEL 8|8GB|GRADE 2":{"avgPrice":319.2,"salesCount":57,"minPrice":291.45,"maxPrice":449.99},"GOOGLE PIXEL 6 PRO|12GB|GRADE 3":{"avgPrice":180.05,"salesCount":44,"minPrice":145.99,"maxPrice":259.99},"GOOGLE PIXEL 8A|8GB|GRADE 1+":{"avgPrice":333.34,"salesCount":43,"minPrice":315.0,"maxPrice":467.99},"SAMSUNG GALAXY S21 FE 5G|6GB|GRADE 2":{"avgPrice":164.7,"salesCount":39,"minPrice":150.0,"maxPrice":182.99},"SAMSUNG GALAXY BOOK3 360|16GB|GRADE 1+":{"avgPrice":793.55,"salesCount":36,"minPrice":780.0,"maxPrice":801.99},"GOOGLE PIXEL 6|8GB|GRADE 2":{"avgPrice":145.32,"salesCount":36,"minPrice":129.99,"maxPrice":176.99},"SAMSUNG GALAXY S21 5G|128GB|GRADE 2":{"avgPrice":173.27,"salesCount":33,"minPrice":165.0,"maxPrice":192.99},"GOOGLE PIXEL 6|8GB|GRADE 3":{"avgPrice":133.12,"salesCount":30,"minPrice":120.99,"maxPrice":171.99},"GOOGLE PIXEL 8 PRO|12GB|GRADE 3":{"avgPrice":385.16,"salesCount":28,"minPrice":340.0,"maxPrice":499.99},"SAMSUNG GALAXY S21+ 5G|8GB|GRADE 2":{"avgPrice":201.7,"salesCount":27,"minPrice":170.99,"maxPrice":257.72},"GOOGLE PIXEL 8|8GB|GRADE 3":{"avgPrice":306.28,"salesCount":27,"minPrice":280.0,"maxPrice":439.99},"SAMSUNG GALAXY S21 FE 5G|6GB|GRADE 3":{"avgPrice":152.88,"salesCount":24,"minPrice":145.0,"maxPrice":171.99},"GOOGLE PIXEL 7A|8GB|GRADE 2":{"avgPrice":162.8,"salesCount":22,"minPrice":131.08,"maxPrice":176.99},"GOOGLE PIXEL 6 PRO|12GB|GRADE 2":{"avgPrice":184.83,"salesCount":22,"minPrice":165.99,"maxPrice":228.99},"SAMSUNG GALAXY S23 ULTRA|8GB|GRADE 2":{"avgPrice":475.18,"salesCount":22,"minPrice":461.99,"maxPrice":511.99},"SAMSUNG GALAXY S21 ULTRA 5G|12GB|GRADE 2":{"avgPrice":294.48,"salesCount":21,"minPrice":262.25,"maxPrice":347.99},"GOOGLE PIXEL 7A|8GB|GRADE 3":{"avgPrice":154.67,"salesCount":21,"minPrice":140.0,"maxPrice":165.99},"SAMSUNG GALAXY S22 5G|8GB|GRADE 2":{"avgPrice":241.21,"salesCount":20,"minPrice":205.0,"maxPrice":305.99},"HUAWEI P30 LITE|4GB|GRADE 2":{"avgPrice":99.92,"salesCount":20,"minPrice":84.75,"maxPrice":150.99},"GOOGLE PIXEL 9 PRO|256GB|GRADE 2":{"avgPrice":690.07,"salesCount":20,"minPrice":673.7,"maxPrice":780.99},"SAMSUNG GALAXY S21 5G|128GB|GRADE 3":{"avgPrice":169.26,"salesCount":19,"minPrice":162.51,"maxPrice":186.99},"SAMSUNG GALAXY S20 FE|6GB|GRADE 3":{"avgPrice":129.98,"salesCount":19,"minPrice":120.99,"maxPrice":150.99},"SAMSUNG GALAXY S21 ULTRA 5G|12GB|GRADE 3":{"avgPrice":269.83,"salesCount":18,"minPrice":242.79,"maxPrice":300.15},"SAMSUNG GALAXY S22 ULTRA 5G|12GB|GRADE 2":{"avgPrice":386.74,"salesCount":17,"minPrice":360.0,"maxPrice":459.03},"GOOGLE PIXEL 8A|8GB|GRADE 1":{"avgPrice":331.29,"salesCount":17,"minPrice":301.78,"maxPrice":436.99},"SAMSUNG GALAXY Z FLIP 4 5G|8GB|GRADE 2":{"avgPrice":238.32,"salesCount":16,"minPrice":200.0,"maxPrice":278.99},"GOOGLE PIXEL 7 PRO|12GB|GRADE 1+":{"avgPrice":275.0,"salesCount":15,"minPrice":275.0,"maxPrice":275.0},"GOOGLE PIXEL 7 PRO|12GB|GRADE 1":{"avgPrice":272.73,"salesCount":15,"minPrice":263.99,"maxPrice":300.0},"SAMSUNG GALAXY A53 5G|6GB|GRADE 2":{"avgPrice":144.87,"salesCount":15,"minPrice":135.99,"maxPrice":168.99},"SAMSUNG GALAXY S20+|8GB|GRADE 2":{"avgPrice":193.23,"salesCount":13,"minPrice":179.99,"maxPrice":216.99},"SAMSUNG GALAXY S22+ 5G|8GB|GRADE 2":{"avgPrice":255.77,"salesCount":13,"minPrice":240.0,"maxPrice":293.62},"GOOGLE PIXEL 9 PRO XL|256GB|GRADE 2":{"avgPrice":850.31,"salesCount":13,"minPrice":799.0,"maxPrice":928.99},"SAMSUNG GALAXY S21+ 5G|8GB|GRADE 3":{"avgPrice":184.88,"salesCount":13,"minPrice":172.49,"maxPrice":213.99},"XIAOMI REDMI NOTE 11 PRO 5G|6GB|GRADE 2":{"avgPrice":105.49,"salesCount":13,"minPrice":97.99,"maxPrice":118.99},"SAMSUNG GALAXY S20 5G|8GB|GRADE 2":{"avgPrice":158.23,"salesCount":13,"minPrice":150.0,"maxPrice":178.98},"GOOGLE PIXEL 8 PRO|12GB|GRADE 1":{"avgPrice":484.75,"salesCount":12,"minPrice":461.99,"maxPrice":515.0},"SAMSUNG GALAXY S22 5G|8GB|GRADE 3":{"avgPrice":224.44,"salesCount":12,"minPrice":209.7,"maxPrice":246.99},"GOOGLE PIXEL 6 PRO|12GB|GRADE 1":{"avgPrice":215.82,"salesCount":11,"minPrice":205.0,"maxPrice":237.99},"SAMSUNG GALAXY S21 5G|128GB|GRADE 1":{"avgPrice":198.55,"salesCount":11,"minPrice":185.9,"maxPrice":214.99},"SAMSUNG GALAXY S23 ULTRA|8GB|GRADE 3":{"avgPrice":450.77,"salesCount":11,"minPrice":424.0,"maxPrice":511.99},"GOOGLE PIXEL 8|8GB|GRADE 1+":{"avgPrice":349.0,"salesCount":11,"minPrice":344.99,"maxPrice":368.99},"ONEPLUS NORD 2 5G|8GB|GRADE 3":{"avgPrice":124.08,"salesCount":11,"minPrice":115.71,"maxPrice":137.99},"SAMSUNG GALAXY Z FLIP 3 5G|8GB|GRADE 2":{"avgPrice":183.59,"salesCount":10,"minPrice":169.99,"maxPrice":214.99},"SAMSUNG GALAXY A54 5G|8GB|GRADE 2":{"avgPrice":189.3,"salesCount":10,"minPrice":169.99,"maxPrice":221.99},"GOOGLE PIXEL 9 PRO XL|256GB|GRADE 3":{"avgPrice":825.29,"salesCount":10,"minPrice":775.0,"maxPrice":855.0},"GOOGLE PIXEL 8 PRO|12GB|GRADE 1+":{"avgPrice":433.73,"salesCount":10,"minPrice":415.0,"maxPrice":505.99},"SAMSUNG GALAXY S22 ULTRA 5G|12GB|GRADE 3":{"avgPrice":357.6,"salesCount":10,"minPrice":337.99,"maxPrice":420.0},"SAMSUNG GALAXY S20 FE|8GB|GRADE 2":{"avgPrice":130.47,"salesCount":10,"minPrice":117.99,"maxPrice":148.99},"GOOGLE PIXEL 6 PRO|12GB|GRADE 1+":{"avgPrice":191.99,"salesCount":9,"minPrice":191.99,"maxPrice":191.99},"XIAOMI 13T 5G|8GB|GRADE 2":{"avgPrice":183.44,"salesCount":9,"minPrice":177.99,"maxPrice":190.99},"XIAOMI 12 LITE 5G|8GB|GRADE 3":{"avgPrice":129.66,"salesCount":9,"minPrice":120.99,"maxPrice":147.99},"XIAOMI 13T PRO 5G|12GB|GRADE 2":{"avgPrice":254.67,"salesCount":9,"minPrice":240.0,"maxPrice":268.0},"SAMSUNG GALAXY S21+ 5G|8GB|GRADE 1":{"avgPrice":216.66,"salesCount":9,"minPrice":202.24,"maxPrice":240.0},"SAMSUNG GALAXY S20 PLUS 5G|8GB|GRADE 2":{"avgPrice":170.0,"salesCount":8,"minPrice":170.0,"maxPrice":170.0},"SAMSUNG GALAXY Z FOLD 3 5G|12GB|GRADE 2":{"avgPrice":364.0,"salesCount":8,"minPrice":344.99,"maxPrice":392.99},"SAMSUNG GALAXY S23 FE 5G|8GB|GRADE 2":{"avgPrice":317.68,"salesCount":8,"minPrice":310.0,"maxPrice":342.99},"SAMSUNG GALAXY Z FLIP 5 5G|8GB|GRADE 2":{"avgPrice":398.74,"salesCount":8,"minPrice":370.0,"maxPrice":449.99},"GOOGLE PIXEL 8 PRO|12GB|GRADE 2":{"avgPrice":397.1,"salesCount":8,"minPrice":350.0,"maxPrice":656.99},"SAMSUNG GALAXY S23+ 5G|8GB|GRADE 2":{"avgPrice":384.29,"salesCount":7,"minPrice":359.99,"maxPrice":418.99},"SAMSUNG GALAXY S21 ULTRA 5G|12GB|GRADE 1":{"avgPrice":311.0,"salesCount":7,"minPrice":298.73,"maxPrice":329.99},"XIAOMI 12 PRO 5G|12GB|GRADE 3":{"avgPrice":216.14,"salesCount":7,"minPrice":200.0,"maxPrice":244.99},"SAMSUNG GALAXY Z FLIP 3 5G|8GB|GRADE 3":{"avgPrice":167.86,"salesCount":7,"minPrice":155.0,"maxPrice":188.99},"SAMSUNG GALAXY A15 5G|4GB|GRADE 2":{"avgPrice":109.86,"salesCount":7,"minPrice":104.99,"maxPrice":116.99},"GOOGLE PIXEL 9|12GB|GRADE 2":{"avgPrice":556.44,"salesCount":7,"minPrice":541.99,"maxPrice":570.0},"SAMSUNG GALAXY S20 FE 5G|6GB|GRADE 2":{"avgPrice":143.81,"salesCount":6,"minPrice":127.99,"maxPrice":153.99},"SAMSUNG GALAXY S20 5G|12GB|GRADE 2":{"avgPrice":144.71,"salesCount":6,"minPrice":138.0,"maxPrice":158.0},"GOOGLE PIXEL 8|8GB|GRADE 1":{"avgPrice":349.16,"salesCount":6,"minPrice":337.99,"maxPrice":373.99},"XIAOMI REDMI NOTE 11 PRO 5G|8GB|GRADE 2":{"avgPrice":113.33,"salesCount":6,"minPrice":109.99,"maxPrice":117.99},"GOOGLE PIXEL 7 PRO|12GB|GRADE 2":{"avgPrice":250.75,"salesCount":6,"minPrice":235.0,"maxPrice":369.99},"SAMSUNG GALAXY A33 5G|6GB|GRADE 2":{"avgPrice":135.0,"salesCount":6,"minPrice":135.0,"maxPrice":135.0},"GOOGLE PIXEL 7|8GB|GRADE 2":{"avgPrice":183.32,"salesCount":6,"minPrice":175.0,"maxPrice":194.99},"ONEPLUS 11 5G|8GB|GRADE 2":{"avgPrice":296.66,"salesCount":6,"minPrice":284.99,"maxPrice":315.0},"SAMSUNG GALAXY S22 ULTRA 5G|12GB|GRADE 1":{"avgPrice":421.66,"salesCount":6,"minPrice":409.99,"maxPrice":435.0},"SAMSUNG GALAXY S20+ 5G|8GB|GRADE 2":{"avgPrice":175.0,"salesCount":5,"minPrice":175.0,"maxPrice":175.0},"SAMSUNG GALAXY S24+ 5G|12GB|GRADE 2":{"avgPrice":572.59,"salesCount":5,"minPrice":544.99,"maxPrice":630.0},"SAMSUNG GALAXY S23+ 5G|8GB|GRADE 3":{"avgPrice":357.8,"salesCount":5,"minPrice":339.99,"maxPrice":380.0},"SAMSUNG GALAXY S23 5G|8GB|GRADE 3":{"avgPrice":354.19,"salesCount":5,"minPrice":329.99,"maxPrice":373.99},"GOOGLE PIXEL 9|12GB|GRADE 3":{"avgPrice":532.99,"salesCount":5,"minPrice":515.0,"maxPrice":565.0},"SAMSUNG GALAXY S23 5G|8GB|GRADE 2":{"avgPrice":389.79,"salesCount":5,"minPrice":374.99,"maxPrice":405.0},"SAMSUNG GALAXY S24 5G|8GB|GRADE 2":{"avgPrice":494.2,"salesCount":5,"minPrice":485.0,"maxPrice":505.0},"SAMSUNG GALAXY A54 5G|8GB|GRADE 3":{"avgPrice":173.79,"salesCount":5,"minPrice":164.99,"maxPrice":189.99},"SAMSUNG GALAXY S22+ 5G|8GB|GRADE 3":{"avgPrice":234.6,"salesCount":5,"minPrice":224.0,"maxPrice":251.99},"GOOGLE PIXEL 7|8GB|GRADE 3":{"avgPrice":173.39,"salesCount":5,"minPrice":169.99,"maxPrice":178.99},"XIAOMI 12X 5G|8GB|GRADE 3":{"avgPrice":181.99,"salesCount":5,"minPrice":174.99,"maxPrice":186.99},"SAMSUNG GALAXY S20+|8GB|GRADE 3":{"avgPrice":180.6,"salesCount":5,"minPrice":171.99,"maxPrice":194.99},"GOOGLE PIXEL 6A|6GB|GRADE 2":{"avgPrice":105.2,"salesCount":5,"minPrice":95.0,"maxPrice":114.99},"GOOGLE PIXEL 9 PRO|256GB|GRADE 3":{"avgPrice":671.99,"salesCount":5,"minPrice":655.0,"maxPrice":690.0},"SAMSUNG GALAXY Z FLIP 4 5G|8GB|GRADE 3":{"avgPrice":214.39,"salesCount":5,"minPrice":204.99,"maxPrice":222.99},"GOOGLE PIXEL 7|8GB|GRADE 1+":{"avgPrice":200.0,"salesCount":5,"minPrice":200.0,"maxPrice":200.0},"SAMSUNG GALAXY S22 5G|8GB|GRADE 1":{"avgPrice":265.2,"salesCount":5,"minPrice":256.99,"maxPrice":275.0},"XIAOMI 13 5G|8GB|GRADE 2":{"avgPrice":278.0,"salesCount":5,"minPrice":270.0,"maxPrice":285.0},"GOOGLE PIXEL 9 PRO XL|512GB|GRADE 2":{"avgPrice":1000.33,"salesCount":5,"minPrice":987.0,"maxPrice":1020.0}};

        let userStock = [];
        let currentSort = 'default'; // 'default', 'alpha', 'profit'
        let currentView = 'table'; // Start with table view as default

        const platformCommissions = {
            'refurbed': 12,
            'backmarket': 15
        };

        // View toggle button
        document.getElementById('viewToggleBtn').addEventListener('click', function() {
            if (currentView === 'cards') {
                currentView = 'table';
                this.textContent = 'üì¶ Card View';
                this.classList.add('active');
            } else {
                currentView = 'cards';
                this.textContent = 'üìã Table View';
                this.classList.remove('active');
            }
            updateRecommendations();
        });

        // Sort buttons
        document.getElementById('sortAlphaBtn').addEventListener('click', function() {
            currentSort = 'alpha';
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateRecommendations();
        });

        document.getElementById('sortProfitBtn').addEventListener('click', function() {
            currentSort = 'profit';
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateRecommendations();
        });

        // Export to Excel format
        document.getElementById('exportExcelBtn').addEventListener('click', function() {
            if (userStock.length === 0) {
                alert('Please upload a file first!');
                return;
            }
            exportToExcel();
        });

        function exportToExcel() {
            const data = [];
            
            userStock.forEach(item => {
                const matchedPrice = findMatchingPrice(item.make, item.model, item.memory, item.grade);
                if (!matchedPrice) return;
                
                const avgSalePrice = matchedPrice.avgPrice;
                const maxPurchasePrice = calculateMaxPurchasePrice(avgSalePrice);
                const difference = maxPurchasePrice - item.purchasePrice;
                const profitCalc = calculateProfit(avgSalePrice, item.purchasePrice);
                
                data.push({
                    'Make': item.make,
                    'Model': item.model,
                    'Memory': item.memory,
                    'Grade': item.grade,
                    'Quantity': item.quantity,
                    'Your_Price': item.purchasePrice.toFixed(2),
                    'Refurbed_Avg_Sale': avgSalePrice.toFixed(2),
                    'Recommended_Max': maxPurchasePrice.toFixed(2),
                    'Difference': difference.toFixed(2),
                    'Expected_Profit': profitCalc.profit.toFixed(2),
                    'Expected_Margin_%': (profitCalc.margin * 100).toFixed(1),
                    'Status': difference >= 0 ? 'Good Deal' : 'Overpaid'
                });
            });

            // Sort alphabetically
            data.sort((a, b) => {
                const nameA = `${a.Make} ${a.Model}`.toUpperCase();
                const nameB = `${b.Make} ${b.Model}`.toUpperCase();
                return nameA.localeCompare(nameB);
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Analysis');
            XLSX.writeFile(wb, 'Bridge_Nine_Analysis.xlsx');
        }

        function exportToProposal() {
            let text = 'PURCHASE PROPOSAL - RECOMMENDED PRICES\n';
            text += '=' .repeat(80) + '\n\n';
            
            const data = [];
            
            userStock.forEach(item => {
                const matchedPrice = findMatchingPrice(item.make, item.model, item.memory, item.grade);
                if (!matchedPrice) return;
                
                const avgSalePrice = matchedPrice.avgPrice;
                const maxPurchasePrice = calculateMaxPurchasePrice(avgSalePrice);
                
                data.push({
                    make: item.make,
                    model: item.model,
                    memory: item.memory,
                    grade: item.grade,
                    quantity: item.quantity,
                    recommended: maxPurchasePrice
                });
            });

            // Sort alphabetically
            data.sort((a, b) => {
                const nameA = `${a.make} ${a.model}`.toUpperCase();
                const nameB = `${b.make} ${b.model}`.toUpperCase();
                return nameA.localeCompare(nameB);
            });

            data.forEach(item => {
                text += `${item.make} ${item.model} | ${item.memory} | ${item.grade}\n`;
                text += `  Quantity: ${item.quantity}\n`;
                text += `  Recommended Max Price: ‚Ç¨${item.recommended.toFixed(2)}\n`;
                text += `  Total: ‚Ç¨${(item.recommended * item.quantity).toFixed(2)}\n\n`;
            });

            // Calculate totals
            const totalQty = data.reduce((sum, item) => sum + item.quantity, 0);
            const totalValue = data.reduce((sum, item) => sum + (item.recommended * item.quantity), 0);
            
            text += '=' .repeat(80) + '\n';
            text += `TOTAL QUANTITY: ${totalQty} units\n`;
            text += `TOTAL VALUE: ‚Ç¨${totalValue.toFixed(2)}\n`;

            // Download as text file
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Bridge_Nine_Proposal.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('platform').addEventListener('change', function() {
            document.getElementById('commission').value = platformCommissions[this.value] || 12;
            updateRecommendations();
        });

        // Refresh button handler
        document.getElementById('refreshBtn').addEventListener('click', function() {
            this.classList.remove('changed');
            updateRecommendations();
        });

        // Mark button as changed when settings change (but don't auto-update)
        ['commission', 'vatTreatment', 'vatRate', 'accessories', 'freight', 'targetMargin'].forEach(id => {
            document.getElementById(id).addEventListener('change', function() {
                document.getElementById('refreshBtn').classList.add('changed');
            });
            document.getElementById(id).addEventListener('input', function() {
                document.getElementById('refreshBtn').classList.add('changed');
            });
        });

        // File upload handler
        // Quick Check Function
        document.getElementById('quickCheckBtn').addEventListener('click', function() {
            const make = document.getElementById('quickMake').value.trim().toUpperCase();
            const model = document.getElementById('quickModel').value.trim().toUpperCase();
            const memory = document.getElementById('quickMemory').value.trim().toUpperCase();
            const userGrade = document.getElementById('quickGrade').value; // A, B, C, D, E
            const yourPrice = parseFloat(document.getElementById('quickPrice').value);

            // Validate inputs
            if (!make) {
                alert('Please select a Make!');
                return;
            }
            if (!model) {
                alert('Please select a Model!');
                return;
            }
            if (!memory) {
                alert('Please select Storage!');
                return;
            }
            if (!yourPrice || isNaN(yourPrice)) {
                alert('Please enter Your Price!');
                return;
            }

            // Convert A-E to internal grade system
            const gradeMap = {
                'A': 'GRADE 1',
                'B': 'GRADE 2',
                'C': 'GRADE 3',
                'D': 'GRADE 3',
                'E': 'GRADE 3'
            };
            const grade = gradeMap[userGrade] || userGrade;

            // Get settings
            const commission = parseFloat(document.getElementById('commission').value) / 100;
            const vatRate = parseFloat(document.getElementById('vatRate').value) / 100;
            const vatTreatment = document.getElementById('vatTreatment').value;
            const accessories = parseFloat(document.getElementById('accessories').value);
            const freight = parseFloat(document.getElementById('freight').value);
            const targetMargin = parseFloat(document.getElementById('quickTargetMargin').value) / 100;

            // Find matching price - pass combined make+model as the model parameter
            const matchedPrice = findMatchingPrice(make, model, memory, grade);

            const resultDiv = document.getElementById('quickResult');
            
            if (!matchedPrice) {
                resultDiv.innerHTML = `
                    <div class="quick-result-header" style="color: #d63031;">
                        ‚ùå No Sales Data Found
                    </div>
                    <p style="color: #636e72;">
                        No sales data found for: ${make} ${model} ${memory} Grade ${userGrade}
                        <br><br>
                        Try:
                        <br>‚Ä¢ Selecting a different grade
                        <br>‚Ä¢ Uploading fresh Refurbed sales data
                        <br>‚Ä¢ Checking if this model exists in your sales data
                    </p>
                `;
                resultDiv.classList.add('show');
                return;
            }

            const avgSalePrice = matchedPrice.avgPrice;
            
            // Calculate max purchase price
            const maxPurchasePrice = (avgSalePrice * (1 - targetMargin) - avgSalePrice * commission - accessories - freight) / (1 + vatRate);
            
            // Calculate profit with actual purchase price (CORRECT ORDER: salePrice, purchasePrice)
            const profitCalc = calculateProfit(avgSalePrice, yourPrice);
            
            const difference = maxPurchasePrice - yourPrice;
            const isGoodDeal = difference >= 0;
            
            // Build result HTML in card format
            resultDiv.innerHTML = `
                <div style="background: ${isGoodDeal ? '#d4edda' : '#f8d7da'}; padding: 20px; border-radius: 12px; border-left: 5px solid ${isGoodDeal ? '#28a745' : '#dc3545'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #2d3436; font-size: 1.3em;">${make} ${model}</h3>
                        <span style="background: ${isGoodDeal ? '#28a745' : '#dc3545'}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
                            ${isGoodDeal ? '‚úì GOOD DEAL' : '‚ö† OVERPAID'}
                        </span>
                    </div>
                    
                    <div style="color: #636e72; font-size: 1em; margin-bottom: 15px;">
                        ${memory} | Grade ${userGrade}
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 0.85em; color: #636e72; margin-bottom: 5px;">Max Recommended</div>
                                <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">‚Ç¨${maxPurchasePrice.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85em; color: #636e72; margin-bottom: 5px;">Your Price</div>
                                <div style="font-size: 1.8em; font-weight: bold; color: ${isGoodDeal ? '#28a745' : '#dc3545'};">‚Ç¨${yourPrice.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #ecf0f1; font-size: 1.1em; font-weight: bold; color: ${isGoodDeal ? '#28a745' : '#dc3545'};">
                            ${isGoodDeal ? '‚úì Saved' : '‚ö† Over by'} ‚Ç¨${Math.abs(difference).toFixed(2)}
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ecf0f1;">
                            <span style="color: #636e72;">Avg Refurbed Sale:</span>
                            <strong style="color: #2d3436;">‚Ç¨${avgSalePrice.toFixed(2)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ecf0f1;">
                            <span style="color: #636e72;">Expected Profit:</span>
                            <strong style="color: ${profitCalc.profit > 0 ? '#28a745' : '#dc3545'};">‚Ç¨${profitCalc.profit.toFixed(2)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ecf0f1;">
                            <span style="color: #636e72;">Expected Margin:</span>
                            <strong style="color: ${profitCalc.margin >= targetMargin ? '#28a745' : '#dc3545'};">${(profitCalc.margin * 100).toFixed(1)}%</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ecf0f1;">
                            <span style="color: #636e72;">Sales Count:</span>
                            <strong style="color: #2d3436;">${matchedPrice.salesCount}x</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ecf0f1;">
                            <span style="color: #636e72;">Commission:</span>
                            <strong style="color: #2d3436;">‚Ç¨${profitCalc.commissionCost.toFixed(2)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ecf0f1;">
                            <span style="color: #636e72;">VAT:</span>
                            <strong style="color: #2d3436;">‚Ç¨${profitCalc.vatCost.toFixed(2)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <span style="color: #636e72;">Accessories + Freight:</span>
                            <strong style="color: #2d3436;">‚Ç¨${(accessories + freight).toFixed(2)}</strong>
                        </div>
                    </div>
                    
                    ${matchedPrice.adjustedFrom ? `
                        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                            <strong>‚ÑπÔ∏è Note:</strong> Using ${matchedPrice.adjustedFrom} (exact grade not found)
                        </div>
                    ` : ''}
                </div>
            `;
            
            resultDiv.classList.add('show');
        });

        // File upload handler
        document.getElementById('stockUpload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('uploadStatus');
            const clearBtn = document.getElementById('clearFileBtn');
            statusDiv.textContent = 'Processing...';
            statusDiv.style.color = '#17a2b8';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                if (jsonData.length === 0) {
                    statusDiv.textContent = '‚ö† No data found in file';
                    statusDiv.style.color = '#dc3545';
                    return;
                }

                // Check what columns we have
                const sampleRow = jsonData[0];
                const columns = Object.keys(sampleRow);
                
                userStock = [];
                
                for (let row of jsonData) {
                    // Get make, model, memory, grade
                    const make = (row.Make || row.make || '').toString().toUpperCase();
                    const model = (row.Model || row.model || '').toString().toUpperCase();
                    const memory = (row.Memory || row.memory || row.Storage || '').toString();
                    const grade = (row.Grade || row.grade || '').toString().toUpperCase();
                    
                    // Skip if missing essential fields
                    if (!make || !model || !memory || !grade) continue;
                    
                    // Get quantity
                    let quantity = 1;
                    if (row['A/Quantity'] !== undefined) quantity = parseInt(row['A/Quantity']) || 1;
                    else if (row.Qty !== undefined) quantity = parseInt(row.Qty) || 1;
                    else if (row.Quantity !== undefined) quantity = parseInt(row.Quantity) || 1;
                    else if (row['Quantity Available'] !== undefined) quantity = parseInt(row['Quantity Available']) || 1;
                    else if (row['Customer Demand'] !== undefined) quantity = parseInt(row['Customer Demand']) || 1;
                    
                    // Get price - check each column individually (like Quick Check does)
                    let purchasePrice = 0;
                    if (row['Proposed Price']) purchasePrice = parseFloat(row['Proposed Price']);
                    else if (row['Initial Price']) purchasePrice = parseFloat(row['Initial Price']);
                    else if (row['Customer Bid']) purchasePrice = parseFloat(row['Customer Bid']);
                    else if (row['Negotiated Bid']) purchasePrice = parseFloat(row['Negotiated Bid']);
                    else if (row['Your Price']) purchasePrice = parseFloat(row['Your Price']);
                    else if (row.Response) purchasePrice = parseFloat(row.Response);
                    else if (row['Final_Price']) purchasePrice = parseFloat(row['Final_Price']);
                    else if (row['Purchase Price']) purchasePrice = parseFloat(row['Purchase Price']);
                    else if (row.Price) purchasePrice = parseFloat(row.Price);
                    
                    if (isNaN(purchasePrice)) purchasePrice = 0;
                    
                    // Only add if has price
                    if (purchasePrice > 0) {
                        userStock.push({
                            make: make,
                            model: model,
                            memory: memory,
                            grade: grade,
                            quantity: quantity,
                            purchasePrice: purchasePrice
                        });
                    }
                }

                if (userStock.length === 0) {
                    statusDiv.textContent = '‚ö† No items with prices > 0. Columns found: ' + columns.join(', ');
                    statusDiv.style.color = '#dc3545';
                    return;
                }

                statusDiv.textContent = `‚úì Loaded ${userStock.length} items`;
                statusDiv.style.color = '#28a745';
                clearBtn.style.display = 'inline-block';
                updateRecommendations();
            } catch (error) {
                statusDiv.textContent = '‚ö† Error: ' + error.message;
                statusDiv.style.color = '#dc3545';
                console.error(error);
            }
        });

        // Clear file button
        document.getElementById('clearFileBtn').addEventListener('click', function() {
            userStock = [];
            document.getElementById('stockUpload').value = '';
            document.getElementById('uploadStatus').textContent = '';
            this.style.display = 'none';
            currentView = 'cards';
            currentSort = 'default';
            document.getElementById('viewToggleBtn').textContent = 'üìã Table View';
            document.getElementById('viewToggleBtn').classList.remove('active');
            document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
            updateRecommendations();
        });

        // Sales price upload handler
        document.getElementById('salesUpload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('salesUploadStatus');
            statusDiv.textContent = 'Processing...';
            statusDiv.style.color = '#17a2b8';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                // Check if this is Refurbed export format or pre-processed format
                const isRefurbedFormat = jsonData[0] && jsonData[0]['Device Product Instance name EN'];
                
                let updatedCount = 0;
                
                if (isRefurbedFormat) {
                    // Process Refurbed export format
                    const salesData = {};
                    
                    jsonData.forEach(row => {
                        const deviceName = row['Device Product Instance name EN'];
                        const grade = row['Offer Grading'];
                        const price = parseFloat(row['Order Charged EUR']);
                        
                        if (!deviceName || !grade || !price) return;
                        
                        // Parse device name: "Google Pixel 6a 5G | 6 GB | 128 GB | Dual-SIM | black"
                        const parts = deviceName.split('|');
                        if (parts.length < 3) return;
                        
                        const model = parts[0].trim().toUpperCase();
                        
                        // Extract storage (larger GB value)
                        const memoryValues = [];
                        for (let i = 1; i < Math.min(parts.length, 4); i++) {
                            const match = parts[i].match(/(\d+)\s*GB/);
                            if (match) memoryValues.push(parseInt(match[1]));
                        }
                        const storage = memoryValues.length > 0 ? Math.max(...memoryValues) : null;
                        if (!storage) return;
                        
                        // Map Refurbed grade to our format
                        const gradeMap = {
                            'A': 'GRADE 1',
                            'A+': 'GRADE 1+',
                            'B': 'GRADE 2',
                            'C': 'GRADE 3',
                            'D': 'GRADE 3'  // Map D to GRADE 3 as well
                        };
                        const mappedGrade = gradeMap[grade.toUpperCase()] || grade.toUpperCase();
                        
                        const key = `${model}|${storage}GB|${mappedGrade}`;
                        
                        if (!salesData[key]) {
                            salesData[key] = { prices: [], count: 0 };
                        }
                        salesData[key].prices.push(price);
                        salesData[key].count++;
                    });
                    
                    // Calculate averages and update REFURBED_SALES_PRICES
                    for (const [key, data] of Object.entries(salesData)) {
                        const avgPrice = data.prices.reduce((a, b) => a + b, 0) / data.prices.length;
                        REFURBED_SALES_PRICES[key] = { 
                            avgPrice: avgPrice,
                            salesCount: data.count 
                        };
                        updatedCount++;
                    }
                } else {
                    // Pre-processed format with Model, Memory, Grade, avgPrice columns
                    jsonData.forEach(row => {
                        const model = (row.Model || row.model || '').toString().trim().toUpperCase();
                        const memory = (row.Memory || row.memory || '').toString().trim();
                        const grade = (row.Grade || row.grade || '').toString().trim().toUpperCase();
                        const avgPrice = parseFloat(row.avgPrice || row['Average Price'] || row.avg_price || 0);
                        const salesCount = parseInt(row.salesCount || row['Sales Count'] || row.sales_count || 0);
                        
                        if (model && grade && avgPrice > 0) {
                            const key = `${model}|${memory}|${grade}`;
                            REFURBED_SALES_PRICES[key] = { avgPrice, salesCount };
                            updatedCount++;
                        }
                    });
                }

                statusDiv.textContent = `‚úì Updated ${updatedCount} prices`;
                statusDiv.style.color = '#28a745';
                
                // Populate Quick Check dropdowns
                populateQuickCheckDropdowns();
                
                // Refresh display
                if (userStock.length > 0) {
                    updateRecommendations();
                } else {
                    updateRecommendations(); // Show default recommendations with new prices
                }
            } catch (error) {
                statusDiv.textContent = '‚ö† Error reading file';
                statusDiv.style.color = '#dc3545';
                console.error(error);
            }
        });

        function calculateMaxPurchasePrice(avgSalePrice) {
            const commission = parseFloat(document.getElementById('commission').value) / 100;
            const vatTreatment = document.getElementById('vatTreatment').value;
            const vatRate = parseFloat(document.getElementById('vatRate').value) / 100;
            const accessories = parseFloat(document.getElementById('accessories').value);
            const freight = parseFloat(document.getElementById('freight').value);
            const targetMargin = parseFloat(document.getElementById('targetMargin').value) / 100;
            
            const commissionCost = avgSalePrice * commission;
            
            if (vatTreatment === 'marginal') {
                return (avgSalePrice * (1 - targetMargin) - commissionCost - accessories - freight) / (1 + vatRate);
            } else {
                const netSale = avgSalePrice - commissionCost - accessories - freight;
                const vatCost = netSale * (vatRate / (1 + vatRate));
                return avgSalePrice * (1 - targetMargin) - vatCost - commissionCost - accessories - freight;
            }
        }

        function calculateProfit(salePrice, purchasePrice) {
            const commission = parseFloat(document.getElementById('commission').value) / 100;
            const vatTreatment = document.getElementById('vatTreatment').value;
            const vatRate = parseFloat(document.getElementById('vatRate').value) / 100;
            const accessories = parseFloat(document.getElementById('accessories').value);
            const freight = parseFloat(document.getElementById('freight').value);
            
            // Commission is always on sale price
            const commissionCost = salePrice * commission;
            
            let vatCost;
            if (vatTreatment === 'marginal') {
                // Marginal VAT: (SalePrice √ó VATRate) - (PurchasePrice √ó VATRate)
                // Which simplifies to: (SalePrice - PurchasePrice) √ó VATRate
                vatCost = (salePrice * vatRate) - (purchasePrice * vatRate);
            } else {
                // Reverse charge
                const netSale = salePrice - commissionCost - accessories - freight;
                vatCost = netSale * (vatRate / (1 + vatRate));
            }
            
            // Profit = SalePrice - PurchasePrice - VAT - Commission - Accessories - Freight
            const profit = salePrice - purchasePrice - vatCost - commissionCost - accessories - freight;
            
            // Margin = Profit / PurchasePrice (NOT sale price!)
            const margin = profit / purchasePrice;
            
            return { profit, margin, vatCost, commissionCost };
        }

        function findMatchingPrice(make, model, memory, grade) {
            // Normalize inputs
            let fullModel = `${make} ${model}`.trim().toUpperCase();
            let memoryStr = memory.toString().trim().toUpperCase();
            let gradeStr = grade.toString().trim().toUpperCase();
            
            // Remove "5G" suffix for better matching (Pixel 7 Pro 5G ‚Üí Pixel 7 Pro)
            fullModel = fullModel.replace(/\s*5G\s*$/i, '').trim();
            
            // Map PGL and PDW to GRADE 3
            if (gradeStr === 'PGL' || gradeStr === 'PDW') {
                gradeStr = 'GRADE 3';
            }
            
            // Determine if memory is storage (64GB+) or RAM (16GB or less)
            const memValue = parseInt(memoryStr);
            const isStorage = memValue >= 64;
            
            // Priority 1: Exact match (model + storage + grade)
            for (const key in REFURBED_SALES_PRICES) {
                const parts = key.split('|');
                if (parts.length >= 3) {
                    let keyModel = parts[0].trim().replace(/\s*5G\s*$/i, '').trim();
                    const keyMemory = parts[1].trim();
                    const keyGrade = parts[2].trim();
                    
                    if (keyModel === fullModel && keyMemory === memoryStr && keyGrade === gradeStr) {
                        return REFURBED_SALES_PRICES[key];
                    }
                }
            }
            
            // Priority 2: Same model + same storage, fallback grades
            if (isStorage) {
                // For GRADE 3: try C, then B-10%, then A-20%
                // For GRADE 2: try B, then A-10%
                // For GRADE 1/1+: try A
                
                let fallbackGrades = [];
                if (gradeStr === 'GRADE 3') {
                    fallbackGrades = [
                        { grade: 'GRADE 2', discount: 0.10 },  // B minus 10%
                        { grade: 'GRADE 1', discount: 0.20 },  // A minus 20%
                        { grade: 'GRADE 1+', discount: 0.20 }  // A+ minus 20%
                    ];
                } else if (gradeStr === 'GRADE 2') {
                    fallbackGrades = [
                        { grade: 'GRADE 1', discount: 0.10 },  // A minus 10%
                        { grade: 'GRADE 1+', discount: 0.10 }  // A+ minus 10%
                    ];
                } else if (gradeStr === 'GRADE 1') {
                    fallbackGrades = [
                        { grade: 'GRADE 1+', discount: 0 }  // Use A+ without discount
                    ];
                }
                
                for (const fallback of fallbackGrades) {
                    for (const key in REFURBED_SALES_PRICES) {
                        const parts = key.split('|');
                        if (parts.length >= 3) {
                            let keyModel = parts[0].trim().replace(/\s*5G\s*$/i, "").trim();
                            const keyMemory = parts[1].trim();
                            const keyGrade = parts[2].trim();
                            
                            if (keyModel === fullModel && keyMemory === memoryStr && keyGrade === fallback.grade) {
                                const basePrice = REFURBED_SALES_PRICES[key];
                                // Apply discount
                                return {
                                    avgPrice: basePrice.avgPrice * (1 - fallback.discount),
                                    salesCount: basePrice.salesCount,
                                    adjustedFrom: `${fallback.grade} -${(fallback.discount * 100).toFixed(0)}%`
                                };
                            }
                        }
                    }
                }
            }
            
            // Priority 3: Match model + grade, any storage
            let bestMatch = null;
            let hasStorageMatch = false;
            
            for (const key in REFURBED_SALES_PRICES) {
                const parts = key.split('|');
                if (parts.length >= 3) {
                    let keyModel = parts[0].trim().replace(/\s*5G\s*$/i, "").trim();
                    const keyMemory = parts[1].trim();
                    const keyGrade = parts[2].trim();
                    
                    if (keyModel === fullModel && keyGrade === gradeStr) {
                        const keyMemValue = parseInt(keyMemory);
                        const keyIsStorage = keyMemValue >= 64;
                        
                        if (!bestMatch) {
                            bestMatch = REFURBED_SALES_PRICES[key];
                            hasStorageMatch = keyIsStorage;
                        } else if (keyIsStorage && !hasStorageMatch) {
                            bestMatch = REFURBED_SALES_PRICES[key];
                            hasStorageMatch = true;
                        }
                    }
                }
            }
            
            if (bestMatch) {
                return bestMatch;
            }
            
            // Priority 4: Partial model match
            for (const key in REFURBED_SALES_PRICES) {
                const parts = key.split('|');
                if (parts.length >= 3) {
                    let keyModel = parts[0].trim().replace(/\s*5G\s*$/i, "").trim();
                    const keyGrade = parts[2].trim();
                    
                    if ((keyModel.includes(fullModel) || fullModel.includes(keyModel)) && keyGrade === gradeStr) {
                        return REFURBED_SALES_PRICES[key];
                    }
                }
            }
            
            return null;
        }

        function populateQuickCheckDropdowns() {
            console.log('Populating Quick Check dropdowns...');
            console.log('Total entries in REFURBED_SALES_PRICES:', Object.keys(REFURBED_SALES_PRICES).length);
            
            const makeSelect = document.getElementById('quickMake');
            const modelSelect = document.getElementById('quickModel');
            const memorySelect = document.getElementById('quickMemory');
            
            if (!makeSelect || !modelSelect || !memorySelect) {
                console.error('Quick Check dropdowns not found!');
                return;
            }
            
            // Remove old event listeners by cloning (prevents duplicates)
            const newMakeSelect = makeSelect.cloneNode(false);
            const newModelSelect = modelSelect.cloneNode(false);
            makeSelect.parentNode.replaceChild(newMakeSelect, makeSelect);
            modelSelect.parentNode.replaceChild(newModelSelect, modelSelect);
            
            // Update references
            const makeSelectUpdated = document.getElementById('quickMake');
            const modelSelectUpdated = document.getElementById('quickModel');
            
            // Get unique makes, models, and storage from REFURBED_SALES_PRICES
            const makes = new Set();
            const modelsByMake = {};
            const storageByMakeModel = {};
            
            for (const key in REFURBED_SALES_PRICES) {
                const parts = key.split('|');
                if (parts.length >= 3) {
                    const fullModel = parts[0].trim();
                    const storage = parts[1].trim();
                    
                    // Try to split into make and model
                    const words = fullModel.split(' ');
                    if (words.length >= 2) {
                        const make = words[0]; // First word is usually the make
                        const model = words.slice(1).join(' '); // Rest is model
                        
                        makes.add(make);
                        
                        if (!modelsByMake[make]) {
                            modelsByMake[make] = new Set();
                        }
                        modelsByMake[make].add(model);
                        
                        // Store storage options by make+model
                        const makeModelKey = `${make}|${model}`;
                        if (!storageByMakeModel[makeModelKey]) {
                            storageByMakeModel[makeModelKey] = new Set();
                        }
                        storageByMakeModel[makeModelKey].add(storage);
                    }
                }
            }
            
            // Populate Make dropdown
            makeSelectUpdated.innerHTML = '<option value="">Select Make...</option>';
            const makeArray = Array.from(makes).sort();
            console.log('Found makes:', makeArray);
            
            makeArray.forEach(make => {
                const option = document.createElement('option');
                option.value = make;
                option.textContent = make;
                makeSelectUpdated.appendChild(option);
            });
            
            // Update Model dropdown when Make changes
            makeSelectUpdated.addEventListener('change', function() {
                const selectedMake = this.value;
                modelSelectUpdated.innerHTML = '<option value="">Select Model...</option>';
                memorySelect.innerHTML = '<option value="">Select Storage...</option>';
                
                if (selectedMake && modelsByMake[selectedMake]) {
                    Array.from(modelsByMake[selectedMake]).sort().forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelectUpdated.appendChild(option);
                    });
                }
            });
            
            // Update Storage dropdown when Model changes
            modelSelectUpdated.addEventListener('change', function() {
                const selectedMake = makeSelectUpdated.value;
                const selectedModel = this.value;
                memorySelect.innerHTML = '<option value="">Select Storage...</option>';
                
                if (selectedMake && selectedModel) {
                    const makeModelKey = `${selectedMake}|${selectedModel}`;
                    
                    if (storageByMakeModel[makeModelKey]) {
                        // Filter to show only storage (64GB+), exclude RAM (16GB or less)
                        const storages = Array.from(storageByMakeModel[makeModelKey])
                            .filter(storage => {
                                const numValue = parseInt(storage);
                                return numValue >= 32; // Show 32GB and above (include all storage sizes)
                            })
                            .sort((a, b) => {
                                const numA = parseInt(a);
                                const numB = parseInt(b);
                                return numA - numB;
                            });
                        
                        if (storages.length > 0) {
                            storages.forEach(storage => {
                                const option = document.createElement('option');
                                option.value = storage;
                                option.textContent = storage;
                                memorySelect.appendChild(option);
                            });
                        }
                    }
                }
            });
        }

        function updateRecommendations() {
            const container = document.getElementById('recommendations');
            
            if (userStock.length === 0) {
                showDefaultRecommendations(container);
                return;
            }

            // Prepare data for sorting
            const displayData = [];
            
            userStock.forEach(item => {
                const matchedPrice = findMatchingPrice(item.make, item.model, item.memory, item.grade);
                if (!matchedPrice) return;

                const avgSalePrice = matchedPrice.avgPrice;
                const maxPurchasePrice = calculateMaxPurchasePrice(avgSalePrice);
                const yourPrice = item.purchasePrice;
                const difference = maxPurchasePrice - yourPrice;
                const isGoodDeal = difference >= 0;
                const profitCalc = calculateProfit(avgSalePrice, yourPrice);
                
                displayData.push({
                    item,
                    matchedPrice,
                    avgSalePrice,
                    maxPurchasePrice,
                    yourPrice,
                    difference,
                    isGoodDeal,
                    profitCalc
                });
            });

            // Apply sorting
            if (currentSort === 'alpha') {
                displayData.sort((a, b) => {
                    const nameA = `${a.item.make} ${a.item.model}`.toUpperCase();
                    const nameB = `${b.item.make} ${b.item.model}`.toUpperCase();
                    return nameA.localeCompare(nameB);
                });
            } else if (currentSort === 'profit') {
                displayData.sort((a, b) => b.profitCalc.profit - a.profitCalc.profit);
            }

            let html = '';
            let totalItems = 0;
            let goodDeals = 0;
            let badDeals = 0;
            let totalSavings = 0;
            let totalOverpaid = 0;

            displayData.forEach(({ item, matchedPrice, avgSalePrice, maxPurchasePrice, yourPrice, difference, isGoodDeal, profitCalc }) => {
                totalItems++;
                
                if (isGoodDeal) {
                    goodDeals++;
                    totalSavings += difference * item.quantity;
                } else {
                    badDeals++;
                    totalOverpaid += Math.abs(difference) * item.quantity;
                }
                
                let gradeClass = 'grade-pgl';
                if (item.grade.includes('1')) gradeClass = 'grade-1';
                else if (item.grade.includes('2')) gradeClass = 'grade-2';
                else if (item.grade.includes('3')) gradeClass = 'grade-3';

                html += `
                    <div class="rec-card ${isGoodDeal ? 'good-deal' : 'bad-deal'}">
                        <span class="deal-badge ${isGoodDeal ? 'good' : 'bad'}">
                            ${isGoodDeal ? '‚úì Good Deal' : '‚ö† Overpaid'}
                        </span>
                        <h3>${item.make} ${item.model}</h3>
                        <div class="model-info">${item.memory} | Qty: ${item.quantity}</div>
                        <span class="grade-badge ${gradeClass}">${item.grade}</span>
                        
                        <div class="price-comparison">
                            <div class="price-box max-price-box">
                                <div class="price-label">Max Recommended</div>
                                <div class="price-value">‚Ç¨${maxPurchasePrice.toFixed(2)}</div>
                            </div>
                            <div class="price-box your-price-box ${!isGoodDeal ? 'overpaid' : ''}">
                                <div class="price-label">Your Price</div>
                                <div class="price-value">‚Ç¨${yourPrice.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div class="${isGoodDeal ? 'savings' : 'overpaid'}" style="text-align: center;">
                            ${isGoodDeal ? '‚úì' : '‚ö†'} ${isGoodDeal ? 'Saved' : 'Over by'} ‚Ç¨${Math.abs(difference).toFixed(2)} per unit
                            <br><small>(‚Ç¨${Math.abs(difference * item.quantity).toFixed(2)} total for ${item.quantity} ${item.quantity === 1 ? 'unit' : 'units'})</small>
                        </div>

                        <div class="stats">
                            <div class="stats-row">
                                <span>Avg Refurbed Sale:</span>
                                <strong>‚Ç¨${avgSalePrice.toFixed(2)}</strong>
                            </div>
                            <div class="stats-row">
                                <span>Expected Profit:</span>
                                <strong style="color: ${profitCalc.profit > 0 ? '#28a745' : '#dc3545'}">
                                    ‚Ç¨${profitCalc.profit.toFixed(2)}
                                </strong>
                            </div>
                            <div class="stats-row">
                                <span>Expected Margin:</span>
                                <strong style="color: ${profitCalc.margin > 0 ? '#28a745' : '#dc3545'}">
                                    ${(profitCalc.margin * 100).toFixed(1)}%
                                </strong>
                            </div>
                            <div class="stats-row">
                                <span>Refurbed Sales:</span>
                                <strong>${matchedPrice.salesCount}x</strong>
                            </div>
                        </div>

                        <div class="cost-breakdown">
                            <div style="font-weight: 600; margin-bottom: 4px; color: #856404;">Cost Breakdown:</div>
                            <div class="stats-row">
                                <span>Commission:</span>
                                <span>‚Ç¨${profitCalc.commissionCost.toFixed(2)}</span>
                            </div>
                            <div class="stats-row">
                                <span>VAT:</span>
                                <span>‚Ç¨${profitCalc.vatCost.toFixed(2)}</span>
                            </div>
                            <div class="stats-row">
                                <span>Accessories + Freight:</span>
                                <span>‚Ç¨${(parseFloat(document.getElementById('accessories').value) + parseFloat(document.getElementById('freight').value)).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Render based on view mode
            if (currentView === 'table') {
                container.innerHTML = renderTableView(displayData) || '<div class="info-box">No matching items found in Refurbed sales data</div>';
            } else {
                container.innerHTML = html || '<div class="info-box">No matching items found in Refurbed sales data</div>';
            }
        }

        function renderTableView(displayData) {
            const accessories = parseFloat(document.getElementById('accessories').value);
            const freight = parseFloat(document.getElementById('freight').value);
            
            let html = '<div class="table-container"><table class="data-table">';
            html += `
                <thead>
                    <tr>
                        <th>Make</th>
                        <th>Model</th>
                        <th>Memory</th>
                        <th>Grade</th>
                        <th>Qty</th>
                        <th>Your Price</th>
                        <th>Max Recommended</th>
                        <th>Difference</th>
                        <th>Refurbed Avg</th>
                        <th>Commission</th>
                        <th>VAT</th>
                        <th>Acc+Freight</th>
                        <th>Exp. Profit</th>
                        <th>Exp. Margin</th>
                        <th>Sales</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
            `;

            displayData.forEach(({ item, matchedPrice, avgSalePrice, maxPurchasePrice, yourPrice, difference, isGoodDeal, profitCalc }) => {
                const rowClass = isGoodDeal ? 'good-row' : 'bad-row';
                const statusClass = isGoodDeal ? 'status-good' : 'status-bad';
                const statusText = isGoodDeal ? '‚úì Good' : '‚ö† Over';

                html += `
                    <tr class="${rowClass}">
                        <td>${item.make}</td>
                        <td>${item.model}</td>
                        <td>${item.memory}</td>
                        <td>${item.grade}</td>
                        <td style="text-align: center;">${item.quantity}</td>
                        <td style="text-align: right; font-weight: 600;">‚Ç¨${yourPrice.toFixed(2)}</td>
                        <td style="text-align: right; background: #e7f3ff; font-weight: 600;">‚Ç¨${maxPurchasePrice.toFixed(2)}</td>
                        <td style="text-align: right; font-weight: 600;" class="${statusClass}">${difference >= 0 ? '+' : ''}‚Ç¨${difference.toFixed(2)}</td>
                        <td style="text-align: right;">‚Ç¨${avgSalePrice.toFixed(2)}</td>
                        <td style="text-align: right;">‚Ç¨${profitCalc.commissionCost.toFixed(2)}</td>
                        <td style="text-align: right;">‚Ç¨${profitCalc.vatCost.toFixed(2)}</td>
                        <td style="text-align: right;">‚Ç¨${(accessories + freight).toFixed(2)}</td>
                        <td style="text-align: right; color: ${profitCalc.profit > 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">‚Ç¨${profitCalc.profit.toFixed(2)}</td>
                        <td style="text-align: right; color: ${profitCalc.margin > 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">${(profitCalc.margin * 100).toFixed(1)}%</td>
                        <td style="text-align: center;">${matchedPrice.salesCount}x</td>
                        <td class="${statusClass}" style="text-align: center; font-weight: 600;">${statusText}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            return html;
        }

        function showDefaultRecommendations(container) {
            let html = '';
            
            let sortedData = Object.entries(REFURBED_SALES_PRICES);
            
            // Apply sorting
            if (currentSort === 'alpha') {
                sortedData.sort((a, b) => a[0].localeCompare(b[0]));
            } else {
                sortedData.sort((a, b) => b[1].salesCount - a[1].salesCount);
            }
            
            sortedData = sortedData.slice(0, 50); // Show top 50

            sortedData.forEach(([key, data]) => {
                const [model, memory, grade] = key.split('|');
                const avgSalePrice = data.avgPrice;
                const maxPurchasePrice = calculateMaxPurchasePrice(avgSalePrice);
                
                if (maxPurchasePrice <= 0) return;
                
                const profitCalc = calculateProfit(avgSalePrice, maxPurchasePrice);
                
                let gradeClass = 'grade-pgl';
                if (grade.includes('1')) gradeClass = 'grade-1';
                else if (grade.includes('2')) gradeClass = 'grade-2';
                else if (grade.includes('3')) gradeClass = 'grade-3';

                html += `
                    <div class="rec-card">
                        <h3>${model}</h3>
                        <div class="model-info">${memory}</div>
                        <span class="grade-badge ${gradeClass}">${grade}</span>
                        <div style="text-align: center; margin: 15px 0;">
                            <div class="price-label">Max Purchase Price</div>
                            <div class="price-value" style="color: #667eea; font-size: 2em;">‚Ç¨${maxPurchasePrice.toFixed(2)}</div>
                        </div>
                        <div class="stats">
                            <div class="stats-row">
                                <span>Avg Refurbed Sale:</span>
                                <strong>‚Ç¨${avgSalePrice.toFixed(2)}</strong>
                            </div>
                            <div class="stats-row">
                                <span>Sales Count:</span>
                                <strong>${data.salesCount}x</strong>
                            </div>
                            <div class="stats-row">
                                <span>Expected Profit:</span>
                                <strong style="color: #28a745;">‚Ç¨${profitCalc.profit.toFixed(2)}</strong>
                            </div>
                            <div class="stats-row">
                                <span>Expected Margin:</span>
                                <strong style="color: #28a745;">${(profitCalc.margin * 100).toFixed(1)}%</strong>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Initial display
        updateRecommendations();
        
        // Populate Quick Check dropdowns if data already exists
        if (Object.keys(REFURBED_SALES_PRICES).length > 0) {
            populateQuickCheckDropdowns();
        }
        
        // Set initial button text based on default view
        if (currentView === 'table') {
            document.getElementById('viewToggleBtn').textContent = 'üì¶ Card View';
            document.getElementById('viewToggleBtn').classList.add('active');
        }
    </script>
</body>
</html>
